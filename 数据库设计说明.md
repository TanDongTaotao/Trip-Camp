# 数据库设计说明（MongoDB / Trip-Camp）

本说明文档用于交代本项目的数据库（MongoDB Atlas）设计，内容对齐训练营大作业要求（“商户端管理酒店信息 + 用户端预订流程”）。

## 1. 作业要求映射（为什么这样设计）

作业明确要求：

- 账号角色：商户、管理员（登录/注册）；用户端不要求登录
- 用户端页面：酒店查询页（首页）、酒店列表页、酒店详情页
- 管理端页面：酒店信息录入/编辑/修改（商户）、酒店信息审核/发布/下线（管理员）
- 酒店信息必须维度：酒店名（中/英显示）、酒店地址、酒店星级、酒店房型、酒店价格、酒店开业时间
- 审核状态：通过/不通过/审核中，不通过需要原因；下线不是删除，支持恢复

因此数据库的核心对象是：

- 用户（包含 role）
- 酒店（包含必做信息 + 房型 + 审核/上线状态机 + 商户归属）

## 2. 数据库与集合（Collections）规划

最小可交付（必做闭环）只需要 2 个集合：

- `users`：账号与角色（merchant/admin）
- `hotels`：酒店信息、房型、审核/发布状态、归属关系

可选加分（不影响必做）：

- `audit_logs`：审核日志
- `orders`：预订订单（若要做完整预订闭环再加）

## 3. users（用户集合）

用途：

- 登录/注册
- 权限控制（商户只能操作自己的酒店；管理员可以审核/发布/下线）

字段设计：

- `username`（String，唯一）：登录账号
- `passwordHash`（String）：bcrypt 哈希后的密码
- `role`（String）：`merchant | admin`
- `createdAt` / `updatedAt`（Date）：自动时间戳

索引建议：

- `username` 唯一索引（避免重复注册）

示例文档：

```json
{
  "_id": "ObjectId(...)",
  "username": "merchant_01",
  "passwordHash": "$2a$10$...",
  "role": "merchant",
  "createdAt": "2026-02-01T00:00:00.000Z",
  "updatedAt": "2026-02-01T00:00:00.000Z"
}
```

## 4. hotels（酒店集合）

用途：

- 用户端：查询/列表/详情展示
- 商户端：酒店信息录入/编辑/保存、提交审核
- 管理员端：审核（通过/拒绝+原因）、发布上线、下线（可恢复）

### 4.1 关键设计点（答辩容易讲）

- 用 `ownerId` 表示酒店归属商户，便于做“只能操作自己的酒店”
- 用 2 个字段表达状态机（更清晰）：
  - 审核状态 `auditStatus`：`draft | pending | approved | rejected`
  - 上下线状态 `onlineStatus`：`offline | online`
- 拒绝原因 `rejectReason` 只有在 `rejected` 时才有意义（可为空）
- 下线不是删除：下线只改 `onlineStatus=offline`
- 删除（可选加分）：使用软删除 `deletedAt`，便于恢复或留痕

### 4.2 必做字段（对齐“必须维度”）

基础信息：

- `nameCn`（String）：酒店名（中文）
- `nameEn`（String，可选但建议有）：酒店名（英文）
- `address`（String）
- `city`（String）
- `star`（Number，1-5）
- `openTime`（String 或 Date）：开业时间（推荐 String，例如 `"2015"`，最省事）

房型与价格：

- `minPrice`（Number）：列表页展示“起”
- `roomTypes`（Array）：房型列表（建议直接内嵌在酒店文档里，减少建表与联表复杂度）
  - `name`（String）：房型名
  - `price`（Number）：价格（列表要求房型价格从低到高显示）
  - `amenities`（Array<String>，可选）：房型/设施标签

### 4.3 用户端展示字段（建议）

- `images`（Array<String>）：详情页轮播图
- `coverImage`（String）：列表封面图（可直接取 `images[0]` 或单独存）
- `tags`（Array<String>）：快捷标签（亲子/豪华/免费停车等）

### 4.4 管理流程字段（必须）

归属与状态：

- `ownerId`（ObjectId/String）：商户用户 id
- `auditStatus`（String）：`draft | pending | approved | rejected`
- `onlineStatus`（String）：`offline | online`
- `rejectReason`（String，可空）：审核拒绝原因
- `updateStatus`（String）：`none | draft | pending | rejected`，已上线酒店的修改流程状态
- `updateRejectReason`（String，可空）：修改审核拒绝原因
- `updatePayload`（Mixed，可空）：待审核的修改内容快照

可选加分：

- `deletedAt`（Date，可空）：软删除时间

时间戳：

- `createdAt` / `updatedAt`

### 4.5 索引建议（保证列表查询性能）

用户端可见性筛选常用条件：

- `auditStatus=approved` AND `onlineStatus=online` AND `deletedAt=null`

建议索引：

- `{ auditStatus: 1, onlineStatus: 1, deletedAt: 1 }`
- `{ city: 1 }`
- `{ minPrice: 1 }`
- `{ star: 1 }`
- `{ ownerId: 1 }`（商户查询自己酒店）

关键词搜索（可选）：

- 对 `nameCn`、`address` 建 text 索引（或者先用简单模糊匹配，后期再优化）

### 4.6 示例文档（Hotel）

```json
{
  "_id": "ObjectId(...)",
  "ownerId": "ObjectId(...)",
  "nameCn": "上海外滩观景酒店",
  "nameEn": "Bund View Hotel",
  "address": "上海市黄浦区...",
  "city": "上海",
  "star": 5,
  "openTime": "2015",
  "images": [
    "https://example.com/1.jpg",
    "https://example.com/2.jpg"
  ],
  "coverImage": "https://example.com/1.jpg",
  "tags": ["亲子", "豪华", "免费停车"],
  "roomTypes": [
    { "name": "豪华大床房", "price": 699, "amenities": ["免费WiFi", "早餐"] },
    { "name": "高级双床房", "price": 799 }
  ],
  "minPrice": 699,
  "auditStatus": "pending",
  "onlineStatus": "offline",
  "rejectReason": null,
  "updateStatus": "none",
  "updateRejectReason": null,
  "updatePayload": null,
  "deletedAt": null,
  "createdAt": "2026-02-01T00:00:00.000Z",
  "updatedAt": "2026-02-01T00:00:00.000Z"
}
```

## 5. 角色与数据权限规则（后端必须保证）

- merchant（商户）
  - 只能 CRUD 自己的酒店：`ownerId == 当前登录用户 id`
  - 新建默认：`auditStatus=draft`、`onlineStatus=offline`
  - 提交审核：`draft/rejected → pending`
  - 已上线酒店编辑：保存后 `updateStatus=draft`，提交修改后 `updateStatus=pending`
- admin（管理员）
  - 可查看全部酒店（含不同状态）
  - 审核：`pending → approved/rejected`，拒绝必须写 `rejectReason`
  - 发布：`approved + offline → online`
  - 下线：`online → offline`（可恢复）
  - 修改审核：`updateStatus=pending → none/rejected`，通过后覆盖酒店字段

## 6. 可选加分设计（不做也能完成必做）

### 6.1 audit_logs（审核日志）

用途：记录每一次审核操作，答辩更专业。

字段建议：

- `hotelId`
- `adminId`
- `action`：`approve | reject | publish | offline`
- `reason`（可选）
- `createdAt`

### 6.2 orders（订单/预订）

用途：若你们要做“预订闭环”再加，不是必做。

字段建议：

- `contactName`
- `hotelId`
- `roomTypeName`
- `checkIn` / `checkOut` / `nights`
- `unitPrice` / `totalPrice`
- `status`：`created | paid | cancelled`（示例）
- `createdAt`
