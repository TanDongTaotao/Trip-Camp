# 成员B阶段3（Mobile / Taro）说明文档

本说明基于阶段 0 / 1 / 2 的成果，补充 **阶段 3（最终阶段）** 在移动端的增量实现：  
重点是 **用户体验 / 交互 / 性能 / 与后台联动可见性**，不再增加新的接口类型。

---

## 1. 阶段 3 目标概述

对照总作业说明与《阶段3验收清单》，“成员 B（移动端）”在阶段 3 的目标：

- 在阶段 2 已完成的「查询 → 列表 → 详情」链路基础上：
  - 打磨首页/列表/详情的交互与视觉体验
  - 优化列表长滚动场景下的性能与稳定性
  - 与后台的「商户录入 / 管理员审核 / 发布 / 下线」联动：
    - 仅展示 `approved + online` 的酒店
    - 下线后，用户端列表和详情不可见；再次发布后恢复可见

后端接口层面仍然只依赖：

- 列表：`GET /api/v1/hotels`
- 详情：`GET /api/v1/hotels/:id`

---

## 2. 技术栈与运行环境

阶段 3 沿用阶段 2 的技术栈与运行方式：

- 运行端：H5（Taro 4.1.11 + Webpack5 runner）
- UI：NutUI React Taro（`@nutui/nutui-react-taro@^2.7.15-beta.1`）
- 插件：`@tarojs/plugin-html@4.1.11`
- 语言：JavaScript（未启用 TypeScript）
- Base URL：`http://localhost:3000/api/v1`（沿用阶段 1 / 2 的请求封装）

关键配置参考：

- 插件启用：`config/index.js`  
  → `plugins: ['@tarojs/plugin-framework-react', '@tarojs/plugin-html']`
- 全局样式引入：`src/app.js`  
  → `import '@nutui/nutui-react-taro/dist/style.css'`
- 请求封装：`src/utils/request.js`（自动带 token + 统一错误处理）

---

## 3. 阶段 3 功能增量概览

### 3.1 首页（查询页）交互优化

文件：  
- [pages/home/index.jsx](file:///e:/Code/前端携程训练营/Trip-Camp/apps/mobile/src/pages/home/index.jsx)

在阶段 2 的基础上，本阶段对首页进行了如下增强：

- 查询表单校验：
  - 必选城市：未选择城市直接点击「查找酒店」会 Toast 提示“请选择目的地”
  - 必选日期：未选择入住/离店日期会 Toast 提示“请选择入住和离店日期”
  - 合法日期区间：若离店日期早于或等于入住日期，Toast 提示“离店日期需晚于入住日期”
- 标签筛选支持：
  - 新增快捷标签（如“亲子优选 / 商务出行 / 情侣出行 / 豪华高星”）
  - 点击标签可选中/取消，多选会被拼接为 `tags=亲子优选,商务出行`
  - 查询时将 `tags` 作为 Query 参数传入 `/hotels`，与后端标签筛选联动
- 查询参数构造：
  - 首页会把以下字段组织为 URL Query 传递到列表页：
    - `city`、`checkIn`、`checkOut`、`keyword`、`star`、`tags`
  - 列表页用于回填与请求参数透传

登录态部分仍沿用阶段 1/2 实现（`/auth/me` 静默检查 + 欢迎文案 + 退出登录）。

---

### 3.2 列表页：状态管理 + 性能优化

文件：  
- [pages/list/index.jsx](file:///e:/Code/前端携程训练营/Trip-Camp/apps/mobile/src/pages/list/index.jsx)  
- [pages/list/index.scss](file:///e:/Code/前端携程训练营/Trip-Camp/apps/mobile/src/pages/list/index.scss)

对照阶段 3 要求「loading/empty/error 状态完整 + 上拉加载稳定 + 性能优化」，列表页增量实现包括：

- 查询条件回填与标签展示：
  - 顶部 `SearchBar` 使用首页传入的 `city`、`checkIn` 进行文案回填，便于用户确认当前搜索条件
  - 若首页勾选了标签，列表页在排序 Tabs 下方展示一组 Tag，展示当前生效的标签（例如“亲子优选 / 商务出行”）
- 完整的状态管理：
  - `initialLoading`：首次请求时显示骨架屏（Skeleton），避免白屏
  - `loading`：用于控制“加载中”状态和防重复请求
  - `error`：记录最近一次请求错误，用于展示错误态和“重新加载”入口
  - `hasMore`：控制是否还有下一页数据，避免无限请求
- 可视化状态：
  - 首屏骨架屏：
    - 首次进入列表页时，使用 `Skeleton` 渲染若干占位卡片，提示正在加载数据
  - 空数据：
    - 当列表为空且无错误时，展示 NutUI `Empty` 组件，文案“暂无酒店数据”
  - 错误状态：
    - 接口出错（网络错误/服务器异常）时：
      - Toast 提示“加载失败”
      - 列表区域展示错误文案 + “重新加载”操作，点击后重试第一页请求
  - 底部状态：
    - 当列表有数据时，在底部区域展示：
      - `loading=true`：`<Loading>加载中...</Loading>`
      - `loading=false && hasMore=true`：文案“上拉加载更多”
      - `loading=false && hasMore=false`：文案“没有更多了”
- 分页与防重复请求：
  - 上拉触底（`onScrollToLower`）时：
    - 仅当 `hasMore && !loading` 时才会请求下一页
    - `fetchList` 内部也有 `if (loading) return` 的防抖
  - `hasMore` 计算：
    - 若后端返回 `total`，使用 `page * pageSize < total`
    - 否则退化为“当前页列表长度是否等于 pageSize”
- 交互细节：
  - 列表卡片增加 `hoverStyle`（H5 下有轻微点击态）
  - 点击卡片跳转详情时，会继续携带 `checkIn`、`checkOut`，用于详情页展示“入住离店 Banner”

---

### 3.3 详情页：入住离店展示 + 房型排序 + 下线处理

文件：  
- [pages/detail/index.jsx](file:///e:/Code/前端携程训练营/Trip-Camp/apps/mobile/src/pages/detail/index.jsx)  
- [pages/detail/index.scss](file:///e:/Code/前端携程训练营/Trip-Camp/apps/mobile/src/pages/detail/index.scss)

在阶段 2 已完成大图轮播、基础信息与房型列表的基础上，阶段 3 做了如下优化：

- 入住/离店信息 Banner（“人间夜”展示）：
  - 从路由参数中接收 `checkIn`、`checkOut`
  - 通过 `calcNights(checkIn, checkOut)` 计算入住晚数（X 晚）
  - 在基础信息下方新增“入住离店”卡片：
    - 左侧显示：“入住离店”标题 + `checkIn 至 checkOut`
    - 右侧显示：“共 X 晚” + 提示文案“修改日期请返回列表页”
- 房型排序明确化：
  - 在后端已按价格升序返回 `roomTypes` 的基础上，前端再次用 `price` 升序排序，确保：
    - 房型列表从价格低到高展示
    - 方便答辩时说明“房型排序与商户录入价格一致”
- 下线/不可见酒店的友好处理：
  - 当管理员将酒店下线或删除后，再访问对应的详情接口 `/hotels/:id` 将返回 404
  - 详情页对 404 做了专门处理：
    - Toast 提示“酒店已下线或不存在”
    - 短暂停留后自动 `navigateBack` 返回上一页（通常是列表）
- 加载体验：
  - 请求详情时使用 `Skeleton` 作为骨架屏，避免在数据加载期间出现空白

---

## 4. 与后台联动说明（admin 下线 / 发布）

阶段 3 要求 B 端配合后台完成“可见性联动”：

- 后端接口约定：
  - `GET /hotels`：
    - 仅返回 `auditStatus=approved` 且 `onlineStatus=online` 且未软删除的酒店
  - `GET /hotels/:id`：
    - 未通过审核、已下线或已删除的酒店统一返回 404（`code=NOT_FOUND`）
- 移动端配合行为：
  - 列表页：
    - 完全信任后端可见性规则，仅渲染接口返回的 `list`
    - 当管理员通过 `/admin/hotels/:id/offline` 下线酒店后，用户重新搜索列表会立即看不到该酒店
  - 详情页：
    - 当管理员下线或删除酒店后，用户再访问旧的详情链接会收到 404
    - 前端给出明确提示并自动返回列表，避免“死页”

通过以上设计，保证后台状态机与用户端展示之间的闭环一致性。

---

## 5. 启动与验证流程（阶段 3 建议自测顺序）

前置条件：

- 后端服务：`server` 目录执行 `npm install`、`npm run dev`
- 移动端 H5：`apps/mobile` 目录执行 `npm install`、`npm run dev:h5`  
  → 浏览器访问 `http://localhost:10086/`

推荐验证流程：

1. 使用 Apifox 或管理端：
   - 商户 `POST /merchant/hotels` 新建酒店 → `POST /merchant/hotels/:id/submit` 提交审核
   - 管理员 `POST /admin/hotels/:id/audit` 审核通过 → `POST /admin/hotels/:id/publish` 发布上线
2. 移动端首页：
   - 选择与酒店匹配的城市 + 合法日期区间
   - 可选设置星级、标签，点击「查找酒店」进入列表
3. 列表页：
   - 查看骨架屏 → 列表数据
   - 找到刚刚发布的酒店，验证卡片信息与后台一致
   - 切换价格排序、上拉加载，观察 loading/empty/error 各种状态
4. 详情页：
   - 确认轮播图、入住离店 Banner、房型按价格从低到高展示
5. 后台将该酒店下线：
   - 管理员 `POST /admin/hotels/:id/offline`
   - 移动端再次搜索 → 列表中不再出现该酒店
   - 访问详情 → Toast “酒店已下线或不存在”，自动返回上一页
6. 再次发布上线：
   - 管理员 `POST /admin/hotels/:id/publish`
   - 移动端再次搜索 → 酒店重新出现在列表，详情可正常访问

---

## 6. 阶段 3 验收点对照（移动端视角）

对照根目录《阶段3验收清单.md》中“移动端（B）阶段3”部分，B 端主要对应：

- 列表页上拉加载稳定，不重复请求、不乱序：
  - 通过 `loading` / `hasMore` 控制，`onScrollToLower` 中做防重复请求
- loading / empty / error 状态完整：
  - 首屏骨架屏、Empty 占位、错误状态文案 + 重试入口
- 详情页房型按价格从低到高展示：
  - 后端排序 + 前端二次排序，保证展示顺序稳定
- 交互优化亮点：
  - 首页查询必填校验 + 标签筛选
  - 列表标签回显、排序 Tab、点击态、返回保留条件
  - 详情页入住离店 Banner + 下线 404 友好提示
- 长列表性能：
  - 采用分页 + 上拉加载控制渲染数量
  - 防重复请求 + 骨架屏减少感知卡顿

---

## 7. 关键文件索引（阶段 3 相关）

- 首页查询页：  
  [src/pages/home/index.jsx](file:///e:/Code/前端携程训练营/Trip-Camp/apps/mobile/src/pages/home/index.jsx)
- 列表页：  
  [src/pages/list/index.jsx](file:///e:/Code/前端携程训练营/Trip-Camp/apps/mobile/src/pages/list/index.jsx)  
  [src/pages/list/index.scss](file:///e:/Code/前端携程训练营/Trip-Camp/apps/mobile/src/pages/list/index.scss)
- 详情页：  
  [src/pages/detail/index.jsx](file:///e:/Code/前端携程训练营/Trip-Camp/apps/mobile/src/pages/detail/index.jsx)  
  [src/pages/detail/index.scss](file:///e:/Code/前端携程训练营/Trip-Camp/apps/mobile/src/pages/detail/index.scss)
- 请求封装：  
  [src/utils/request.js](file:///e:/Code/前端携程训练营/Trip-Camp/apps/mobile/src/utils/request.js)
- 全局配置：  
  [src/app.config.js](file:///e:/Code/前端携程训练营/Trip-Camp/apps/mobile/src/app.config.js)  
  [config/index.js](file:///e:/Code/前端携程训练营/Trip-Camp/apps/mobile/config/index.js)

---

## 8. 常见问题与排查（阶段 3 补充）

- 列表始终为空：
  - 检查后端是否已存在 `approved + online` 的酒店数据
  - 使用 Apifox 验证 `GET /hotels` 返回是否正常
- 上拉加载不触发：
  - 确认 Taro `ScrollView` 设置了 `scrollY` 和合适的高度
  - 检查 `onScrollToLower` 是否被触发、`hasMore` 是否为 true
- 详情页提示“酒店已下线或不存在”：
  - 检查该酒店是否被管理员下线或删除
  - 确认这是期望行为，而不是 bug
- 排序看起来不生效：
  - 检查列表请求的 `sort` 参数是否正确传入（`priceAsc` / `priceDesc`）
  - 使用 Apifox 单独调用 `GET /hotels` 检查返回顺序是否已变更

