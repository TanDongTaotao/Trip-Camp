# 后端技术与联调说明（给成员 B / C）

本项目后端由成员 A 维护，供用户端（Taro）与管理端（React+AntD）联调使用。

## 1. 技术栈与开发方式

- 语言：JavaScript（Node.js）
- 框架：Express
- 数据库：MongoDB Atlas（云数据库）
- 鉴权：JWT（Bearer Token）
- 开发方式：nodemon（代码变更自动重启服务）

## 2. 本地联调地址（开发期）

- 后端服务地址（Base URL）：`http://localhost:3000/api/v1`
- 例子：
  - 登录：`POST http://localhost:3000/api/v1/auth/login`
  - 酒店列表：`GET http://localhost:3000/api/v1/hotels`

## 3. 接口文档

- OpenAPI（可导入 Apifox）：[apifox-openapi.yaml](file:///f:/PycharmProjects/Trip-Camp/apifox-openapi.yaml)
- 接口说明（状态流/错误码/落地顺序）：[接口注释说明文档.txt](file:///f:/PycharmProjects/Trip-Camp/%E6%8E%A5%E5%8F%A3%E6%B3%A8%E9%87%8A%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3.txt)

## 4. 你们前端要怎么接

### 4.1 token 怎么用

- 管理端登录/注册成功后会返回 `token`
- 后续需要鉴权的请求统一带请求头：
  - `Authorization: Bearer <token>`

建议：
- 管理端（C）：token 放 localStorage/sessionStorage

### 4.2 角色怎么判断（管理端需要）

- 管理端登录后调用 `GET /auth/me`
- 根据返回的 `user.role` 决定显示“商户”或“管理员”的菜单/页面

注册角色说明（和作业要求对齐）：
- `POST /auth/register` 需要传 `role`
- 默认允许：`merchant`
- 如需要注册 `admin`（作业联调方便），在后端 `.env` 中设置：`ALLOW_ADMIN_REGISTER=true`

## 5. 与后端联调的最小流程

1) Apifox 或管理端先调通：
- `POST /auth/register`
- `POST /auth/login`
- `GET /auth/me`

2) 再开始对接业务：
- 用户端：`GET /hotels`、`GET /hotels/:id`
- 管理端（商户）：`/merchant/hotels*`
- 管理端（管理员）：`/admin/hotels*`

## 6. Apifox 联调流程（可截图交作业）

下面你们照做即可。

### 6.1 导入接口文档（截图 1）

1) 打开 Apifox → 进入项目
2) 导入 → 选择 OpenAPI/Swagger
3) 选择仓库根目录的 [apifox-openapi.yaml](file:///f:/PycharmProjects/Trip-Camp/apifox-openapi.yaml)
4) 导入完成后，左侧会出现接口分组（如 auth/hotels 等）

建议截图内容：
- 导入成功提示
- 左侧接口树结构

### 6.2 配置环境与 Base URL（截图 2）

1) 在 Apifox 新建/选择一个环境（比如：`本地开发`）
2) 设置 Base URL 为：
- `http://localhost:3000/api/v1`
3) 先测试健康检查（如果你们没导入 health，就用浏览器也行）：
- 浏览器访问 `http://localhost:3000/health` 返回 `{"ok":true}` 说明后端已启动

建议截图内容：
- 环境配置里 Base URL 的值
- 浏览器或 Apifox 的 health 返回

### 6.3 注册一个账号（截图 3）

接口：
- `POST /auth/register`

Body（JSON）示例（你们可以直接复制）：

```json
{
  "username": "alice_01",
  "password": "Password123!",
  "role": "merchant"
}
```

成功后应该返回：
- `token`（字符串）
- `user`（包含 id/username/role）

建议截图内容：
- 请求 Body
- 响应里 token 与 user

### 6.4 登录获取 token（截图 4）

接口：
- `POST /auth/login`

Body（JSON）示例：

```json
{
  "username": "alice_01",
  "password": "Password123!"
}
```

成功后会返回 `token`。把 token 复制出来备用。

建议截图内容：
- 登录请求 Body
- 响应 token

### 6.5 调用 me 验证登录态（截图 5）

接口：
- `GET /auth/me`

请求头（Headers）必须带：
- `Authorization: Bearer <token>`

其中 `<token>` 就是 6.4 拿到的 token。

成功响应示例：
- `{"user":{"id":"...","username":"alice_01","role":"merchant"}}`

建议截图内容：
- Headers 里 Authorization 的值（可以只截 Bearer 开头那一行）
- me 的响应 user 信息

### 6.6 常见报错对照表（方便你们快速自查）

- 401 `UNAUTHORIZED`：通常是没带 `Authorization: Bearer ...`，或者 token 复制错了/过期了
- 409 `USERNAME_TAKEN`：用户名已存在，换一个新的 username
- 422 `VALIDATION_ERROR`：参数不符合要求（username 太短、password 太短、role 不在允许范围）
- 连不上服务：检查后端是否已启动、Base URL 是否设置成 `http://localhost:3000/api/v1`
