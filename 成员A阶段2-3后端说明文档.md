# 成员A阶段2-3后端说明文档（Hotels 模块）

本说明用于解释“阶段2用户端酒店查询/列表/详情”与“阶段3商户录入/编辑/提交审核 + 管理员审核/发布/下线（含可选软删除）”的后端实现，包含技术栈与相关文件说明。

---

## 技术栈说明（后端）

- Node.js + Express：提供 RESTful API
- MongoDB + Mongoose：数据存储与模型映射
- dotenv：加载环境变量
- JWT：认证工具（本阶段酒店查询接口不要求登录，但沿用现有鉴权体系）
- bcryptjs：密码哈希（与阶段1账号体系共用）
- nodemon：本地开发热重启
- 自定义中间件：`requireAuth/requireRole` 做鉴权与角色权限控制

---

## 文件说明（与阶段2相关）

### 1) 数据模型

- [Hotel.js](file:///f:/PycharmProjects/Trip-Camp/server/src/models/Hotel.js)
  - 定义酒店主文档与子文档结构
  - 关键字段：`ownerId`、`auditStatus`、`onlineStatus`、`rejectReason`、`deletedAt`
  - 必做字段：`nameCn/nameEn/address/city/star/openTime/minPrice/roomTypes`
  - 用户端展示字段：`coverImage/images/tags/bannerText/nearby/discounts`
  - 保存前钩子：当有 `roomTypes` 时自动把 `minPrice` 纠正为最低房型价（在 `validate` 阶段执行，保证 required 校验前就一致）
  - 索引：可见性筛选索引、城市/价格/星级/ownerId 索引

### 2) 用户端酒店查询路由

- [hotels.js](file:///f:/PycharmProjects/Trip-Camp/server/src/routes/hotels.js)
  - `GET /api/v1/hotels`
    - 筛选：`city/keyword/tags/type/star/minPrice/maxPrice`
    - 排序：`priceAsc/priceDesc/starDesc`
    - 分页：`page/pageSize`
    - 可见性：仅返回 `approved + online + 未删除`
  - `GET /api/v1/hotels/:id`
    - 仅返回可见酒店
    - 非法/不存在/不可见统一返回 404
  - 数据整形：
    - 列表返回最小字段（卡片展示）
    - 详情返回轮播图、房型、周边信息等
    - 房型按价格从低到高排序

### 3) 路由聚合

- [routes/index.js](file:///f:/PycharmProjects/Trip-Camp/server/src/routes/index.js)
  - 将酒店查询路由挂载到 `/api/v1/hotels`
  - 将商户路由挂载到 `/api/v1/merchant`
  - 将管理员路由挂载到 `/api/v1/admin`
  - 统一由 `app.js` 挂载 `/api/v1` 前缀

### 4) 接口契约

- [apifox-openapi.yaml](file:///f:/PycharmProjects/Trip-Camp/apifox-openapi.yaml)
  - `Hotels` 标签下定义用户端列表与详情接口
  - Schema 对齐 `HotelCard/HotelDetail/HotelsListResponse`

---

## 与设计说明的对齐点

- 对齐 [数据库设计说明.md](file:///f:/PycharmProjects/Trip-Camp/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1%E8%AF%B4%E6%98%8E.md) 的酒店字段与状态机
- 用户端可见性规则：仅 `approved + online + 未删除`
- 房型最低价与 `minPrice` 自动一致，避免前端展示异常

---

## 阶段3新增内容（商户 / 管理员酒店管理）

### 1) 商户端酒店管理路由

- [merchant.js](file:///f:/PycharmProjects/Trip-Camp/server/src/routes/merchant.js)
  - 路由挂载：`/api/v1/merchant`
  - 鉴权：必须登录且 `role=merchant`
  - owner 隔离：所有读写都以 `ownerId=req.user.id` 为边界，禁止越权
  - 接口：
    - `POST /merchant/hotels`
      - 新建酒店，默认 `auditStatus=draft`、`onlineStatus=offline`
      - 写入 `ownerId`
      - 参数校验失败统一返回 `{ code, message, details? }`
    - `PUT /merchant/hotels/:id`
      - 仅 owner 可编辑
      - 建议策略：仅 `draft/rejected` 可编辑（否则返回 `409 INVALID_STATE`）
      - 更新房型时 `minPrice` 自动保持与最低房型价一致
    - `POST /merchant/hotels/:id/submit`
      - `draft/rejected -> pending`，并清空 `rejectReason`
    - `GET /merchant/hotels`
      - 仅查询当前 merchant 自己的酒店
      - 支持分页与状态筛选（`auditStatus/onlineStatus`）及关键词搜索（name/address）

### 2) 管理员端审核/发布/下线路由

- [admin.js](file:///f:/PycharmProjects/Trip-Camp/server/src/routes/admin.js)
  - 路由挂载：`/api/v1/admin`
  - 鉴权：必须登录且 `role=admin`
  - 接口：
    - `GET /admin/hotels`
      - 支持按 `auditStatus/onlineStatus` 筛选 + 分页
    - `POST /admin/hotels/:id/audit`
      - `action=approve`：`pending -> approved`
      - `action=reject`：`pending -> rejected`，且 `rejectReason` 必填并落库
    - `POST /admin/hotels/:id/publish`
      - `approved + offline -> online`
    - `POST /admin/hotels/:id/offline`
      - `online -> offline`，可再次 publish 恢复上线
    - `DELETE /admin/hotels/:id`（可选加分）
      - 软删除：写入 `deletedAt`，并强制 `offline`

### 3) 用户端可见性规则（阶段2持续有效）

- 用户端 [hotels.js](file:///f:/PycharmProjects/Trip-Camp/server/src/routes/hotels.js) 仍只返回：
  - `auditStatus=approved`
  - `onlineStatus=online`
  - `deletedAt=null`
